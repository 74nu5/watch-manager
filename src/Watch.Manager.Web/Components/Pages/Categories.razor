@page "/categories"
@using Watch.Manager.Web.Services.Models
@using Watch.Manager.Web.Services
@using Watch.Manager.Common
@using Microsoft.FluentUI.AspNetCore.Components

<h3>üìÅ Gestion des Cat√©gories</h3>

<div class="categories-container">
    <div class="categories-header">
        <FluentButton Appearance="Appearance.Accent" @onclick="ShowCreateDialog">
            ‚ûï Nouvelle Cat√©gorie
        </FluentButton>
        <FluentSwitch @bind-Value="showInactive" @bind-Value:after="OnShowInactiveChanged" Label="Afficher les cat√©gories inactives" />
    </div>

    @if (loading)
    {
        <div class="loading-container">
            <FluentProgressRing />
            <p>Chargement des cat√©gories...</p>
        </div>
    }
    else if (categories.Length == 0)
    {
        <FluentCard>
            <div class="empty-state">
                <p style="font-size: 3em;">üìÅ</p>
                <h4>Aucune cat√©gorie</h4>
                <p>Commencez par cr√©er votre premi√®re cat√©gorie pour organiser vos articles.</p>
                <FluentButton Appearance="Appearance.Accent" @onclick="ShowCreateDialog">
                    Cr√©er une cat√©gorie
                </FluentButton>
            </div>
        </FluentCard>
    }
    else
    {
        <div class="categories-grid">
            @foreach (var category in categories)
            {
                <CategoryCard Category="category"
                             OnEdit="EditCategory"
                             OnDelete="DeleteCategory"
                             OnToggleActive="ToggleActiveCategory" />
            }
        </div>
    }
</div>

<!-- Dialog pour cr√©er/√©diter une cat√©gorie -->
<FluentDialog @bind-Hidden="hideDialog" Modal="true" TrapFocus="true" CloseOnOverlayClick="false">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">
            @(editingCategory == null ? "Nouvelle Cat√©gorie" : "Modifier la Cat√©gorie")
        </FluentLabel>
    </FluentDialogHeader>

    <FluentDialogBody>
        <EditForm Model="categoryForm" OnValidSubmit="SaveCategory">
            <DataAnnotationsValidator />

            <div class="form-group">
                <FluentTextField @bind-Value="categoryForm.Name"
                               Label="Nom *"
                               Required="true"
                               Placeholder="Nom de la cat√©gorie" />
                <ValidationMessage For="@(() => categoryForm.Name)" />
            </div>

            <div class="form-group">
                <FluentTextArea @bind-Value="categoryForm.Description"
                              Label="Description"
                              Placeholder="Description de la cat√©gorie"
                              Rows="3" />
            </div>

            <div class="form-group">
                <FluentTextField @bind-Value="categoryForm.Color"
                               Label="Couleur (hex)"
                               Placeholder="#3498db" />
            </div>

            <div class="form-group">
                <FluentTextField @bind-Value="categoryForm.Icon"
                               Label="Ic√¥ne"
                               Placeholder="folder" />
            </div>

            <div class="form-group">
                <FluentTextField @bind-Value="keywordsText"
                               Label="Mots-cl√©s (s√©par√©s par des virgules)"
                               Placeholder="react, javascript, frontend" />
            </div>

            <div class="form-group">
                <FluentSelect @bind-SelectedOption="selectedParent"
                            Label="Cat√©gorie parente"
                            Placeholder="S√©lectionner une cat√©gorie parente">
                    <FluentOption Value="null">Aucune (cat√©gorie racine)</FluentOption>
                    @foreach (var cat in GetAvailableParentCategories())
                    {
                        <FluentOption Value="cat.Id">@cat.Name</FluentOption>
                    }
                </FluentSelect>
            </div>

            <div class="form-group">
                <FluentNumberField @bind-Value="categoryForm.ConfidenceThreshold"
                                 Label="Seuil de confiance (0.0 - 1.0)"
                                 Min="0"
                                 Max="1"
                                 Step="0.1" />
            </div>

            <div class="dialog-actions">
                <FluentButton @onclick="HideDialog" Appearance="Appearance.Neutral">
                    Annuler
                </FluentButton>
                <FluentButton Type="ButtonType.Submit"
                            Appearance="Appearance.Accent"
                            Loading="saving">
                    @(editingCategory == null ? "Cr√©er" : "Modifier")
                </FluentButton>
            </div>
        </EditForm>
    </FluentDialogBody>
</FluentDialog>

<!-- Dialog de confirmation de suppression -->
<FluentDialog @bind-Hidden="hideDeleteDialog" Modal="true" TrapFocus="true">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">Confirmer la suppression</FluentLabel>
    </FluentDialogHeader>

    <FluentDialogBody>
        <p>√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "<strong>@categoryToDelete?.Name</strong>" ?</p>
        <p class="warning-text">Cette action est irr√©versible et supprimera √©galement toutes les assignations d'articles √† cette cat√©gorie.</p>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton @onclick="HideDeleteDialog" Appearance="Appearance.Neutral">
            Annuler
        </FluentButton>
        <FluentButton @onclick="ConfirmDelete"
                    Appearance="Appearance.Accent"
                    Loading="deleting">
            Supprimer
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<style>
    .categories-container {
        padding: 20px;
    }

    .categories-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .warning-text {
        color: var(--error-color);
        font-weight: 500;
    }
</style>
